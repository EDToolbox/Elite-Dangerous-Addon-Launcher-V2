name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build project
        run: dotnet build --configuration Release --no-restore

      - name: Publish project
        run: dotnet publish --configuration Release --output ./publish --no-build

      - name: Setup NSIS
        run: |
          $nsisZipPath = "$env:TEMP\nsis-3.08.zip"
          $nsisDir = "$env:TEMP\nsis-3.08"

          Write-Host "Downloading NSIS 3.08..."
          # Using GitHub-hosted mirror for reliability
          $nsis_url = "https://github.com/NSIS/nsis/releases/download/v3.08/nsis-3.08.zip"
          try {
            Invoke-WebRequest -Uri $nsis_url -OutFile $nsisZipPath -ErrorAction Stop
          } catch {
            Write-Error "Failed to download NSIS: $_"
            exit 1
          }

          Write-Host "Extracting NSIS..."
          try {
            Expand-Archive -Path $nsisZipPath -DestinationPath $env:TEMP -Force
          } catch {
            Write-Error "Failed to extract NSIS: $_"
            exit 1
          }

          Write-Host "Building installer..."
          $makensisPath = "$nsisDir\makensis.exe"
          if (-not (Test-Path $makensisPath)) {
            Write-Error "makensis.exe not found at $makensisPath"
            exit 1
          }

          & $makensisPath /V4 installer/installer.nsi

          if ($LASTEXITCODE -ne 0) {
            Write-Error "NSIS build failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "Installer created successfully"

      - name: Determine Release Type
        id: release_type
        run: |
          $tag = "${{ github.ref }}" -replace 'refs/tags/', ''
          if ($tag -match '-rc[0-9]' -or $tag -match '-beta[0-9]' -or $tag -match '-alpha[0-9]') {
            Write-Output "is_prerelease=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Output "is_prerelease=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            publish/Elite-Dangerous-Addon-Launcher-Setup.exe
            LICENSE.txt
          body_path: CHANGELOG.md
          prerelease: ${{ steps.release_type.outputs.is_prerelease == 'true' }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: publish/Elite-Dangerous-Addon-Launcher-Setup.exe
